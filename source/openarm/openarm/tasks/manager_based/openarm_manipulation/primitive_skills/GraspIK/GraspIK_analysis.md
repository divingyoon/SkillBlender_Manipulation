# GraspIK code analysis (summary)

This note answers the 4 questions for:
`source/openarm/openarm/tasks/manager_based/openarm_manipulation/primitive_skills/GraspIK`.

## 1) Dual-head 구조가 왼손/오른손을 구분하는가?
Yes.
- PPO policy uses `SbmDualHeadActorCriticCfg` and `ActorCriticDualHead`.
- `ActorCriticDualHead` splits the action vector into **left/right heads** using `dof_split_index`.
- It can also use separate action noise std for left/right and separate critics.

Key files:
- `.../GraspIK/config/agents/rsl_rl_ppo_dualhead_cfg.py`
- `.../sbm/rl/rl_cfg.py` (SbmDualHeadActorCriticCfg)
- `.../sbm/rl/actor_critic_dual_head.py` (dual head actor/critic)

## 2) obs : command 생성하는 구조
Commands are generated by `ObjectPoseCommand` and then **fed into observations** as targets.

Command generation:
- `GraspIKCommandsCfg` defines `left_object_pose` and `right_object_pose`.
- `ObjectPoseCommand` tracks each object pose, then adds an offset:
  - `pre_grasp_offset` when object is not lifted
  - `hold_offset` when object z > `lift_threshold_z`
- Command is converted to robot base frame and stored as 7D pose (pos + quat).

Observation usage:
- Policy observations include `target_object_position` and `target_object2_position`
  using `mdp.generated_commands` with `command_name=left_object_pose/right_object_pose`.

Key files:
- `.../GraspIK/GraspIK_env_cfg.py` (GraspIKCommandsCfg + ObservationsCfg)
- `.../GraspIK/mdp/commands_cfg.py`
- `.../GraspIK/mdp/object_pose_command.py`

## 3) policy 입력/출력
### Inputs (policy obs group)
From `GraspIKObservationsCfg.PolicyCfg` (concatenated):
- `target_object_position` (left command, 7D)
- `target_object2_position` (right command, 7D)
- `joint_pos` (relative)
- `joint_vel` (relative)
- `object_position` (object in robot root frame)
- `object2_position`
- `object_obs` (object + relative info to both EEs)
- `object2_obs`
- `actions` (last action)
- `left_arm_id`, `right_arm_id` (one-hot identifiers, optional)

Note: `GraspIK_env_cfg.py` disables real object positions for the policy group:
`self.observations.policy.object_position = None` and `object2_position = None`.

### Outputs (actions)
Action layout is **left then right** for dual-head:
- left_arm (6) + left_hand (2) = 8
- right_arm (6) + right_hand (2) = 8
- total 16 dims, `dof_split_index=8`

Key files:
- `.../GraspIK/GraspIK_env_cfg.py` (ActionsCfg + ObservationsCfg)
- `.../GraspIK/config/agents/rsl_rl_ppo_dualhead_cfg.py`

## 4) IK 해석 방식
Each arm uses **constrained differential IK** with relative pose commands.
- `ConstrainedDifferentialInverseKinematicsActionCfg`
  - `command_type="pose"`
  - `use_relative_mode=True`
  - IK method: DLS (`lambda_val=0.05`)
- Policy outputs a 6D **delta pose** per arm (relative to current EE pose).
- This delta is converted into joint targets by the differential IK controller.
- Optional constraints: orientation constraint, null-space, joint-limit avoidance.
- Gripper is **joint-position action** (open/close).

Key files:
- `.../GraspIK/config/ik_rel_env_cfg.py`
- `.../GraspIK/mdp/ik_actions.py`

## Diagram (data flow)

```
Object pose (world) ----> ObjectPoseCommand ----> command (7D, base frame)
                                         |                 |
                                         |                 v
                                         |        target_object_position
                                         |        target_object2_position
                                         |
Robot state ----------------------------> obs concat --------------------> PPO policy
  - joint_pos_rel, joint_vel_rel                                   |
  - object_obs / object2_obs (object + rel vecs)                   v
  - last_action                                             actions (16D)
  - (optional) arm_id                                       [L_arm(6), L_grip(2),
                                                             R_arm(6), R_grip(2)]
                                                                  |
                                                                  v
                                                Constrained Differential IK
                                                   -> joint position targets
```

## Observation dimensions (policy group)

> Note: actual sizes can be verified at runtime via train log:
> `policy concatenated dim` print in `scripts/reinforcement_learning/rsl_rl/train.py`.

| Term | Source | Dim | Notes |
|---|---|---:|---|
| target_object_position | `generated_commands(left_object_pose)` | 7 | pos(3) + quat(4) |
| target_object2_position | `generated_commands(right_object_pose)` | 7 | pos(3) + quat(4) |
| joint_pos | `joint_pos_rel` | Nq | robot joints (arm + fingers) |
| joint_vel | `joint_vel_rel` | Nq | same as joint_pos |
| object_position | `object_position_in_robot_root_frame` | 3 | **disabled in GraspIK** (`policy.object_position=None`) |
| object2_position | same | 3 | **disabled in GraspIK** |
| object_obs | `object_obs` | 16 | pos(3)+quat(4)+lin_vel(3)+ang_vel(3)+eef_rel(3) |
| object2_obs | `object2_obs` | 16 | pos(3)+quat(4)+lin_vel(3)+ang_vel(3)+eef_rel(3) |
| actions | `last_action` | 16 | previous action |
| left_arm_id | `left_arm_identifier` | 2 | [1,0] (optional) |
| right_arm_id | `right_arm_identifier` | 2 | [0,1] (optional) |

Where **Nq** is the robot joint count used by `joint_pos_rel/joint_vel_rel`.
For OpenArm bimanual (7+7 arms + 2+2 fingers) this is typically **18**.
